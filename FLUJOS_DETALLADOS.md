# ğŸ”„ Diagramas de Flujo de la AplicaciÃ³n

## Flujo General de Solicitud HTTP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE (Postman, Frontend, Mobile App)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    HTTP Request
                (GET /api/users/me + Token)
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER (Express.js)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ 1. ROUTES (user.routes.js)                                     â”‚
â”‚    â”œâ”€ Recibe solicitud                                         â”‚
â”‚    â”œâ”€ Busca ruta que coincida                                  â”‚
â”‚    â”œâ”€ Ejecuta middlewares asociados                            â”‚
â”‚    â””â”€ Llama al controlador                                     â”‚
â”‚                                                                 â”‚
â”‚ 2. MIDDLEWARE (auth.middleware.js)                             â”‚
â”‚    â”œâ”€ Recibe header Authorization                             â”‚
â”‚    â”œâ”€ Valida token JWT                                         â”‚
â”‚    â””â”€ Si vÃ¡lido: req.user = { id, email }                     â”‚
â”‚       Si invÃ¡lido: responde 401                                â”‚
â”‚                                                                 â”‚
â”‚ 3. CONTROLLER (user.controller.js)                             â”‚
â”‚    â”œâ”€ Recibe req.user del middleware                           â”‚
â”‚    â”œâ”€ Valida datos                                             â”‚
â”‚    â”œâ”€ Llama servicio                                           â”‚
â”‚    â””â”€ Retorna respuesta HTTP + status                          â”‚
â”‚                                                                 â”‚
â”‚ 4. SERVICE (user.service.js)                                   â”‚
â”‚    â”œâ”€ Ejecuta lÃ³gica de negocio                                â”‚
â”‚    â”œâ”€ Valida reglas                                            â”‚
â”‚    â”œâ”€ Llama repository                                         â”‚
â”‚    â””â”€ Retorna datos al controller                              â”‚
â”‚                                                                 â”‚
â”‚ 5. REPOSITORY (user.repository.js)                             â”‚
â”‚    â”œâ”€ Ejecuta query SQL                                        â”‚
â”‚    â”œâ”€ Transforma datos de BD a objeto                          â”‚
â”‚    â””â”€ Retorna al servicio                                      â”‚
â”‚                                                                 â”‚
â”‚ 6. DATABASE (PostgreSQL)                                       â”‚
â”‚    â”œâ”€ Ejecuta SELECT/INSERT/UPDATE/DELETE                      â”‚
â”‚    â””â”€ Retorna datos al repository                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                      Response
                (200 + JSON data)
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE Recibe Respuesta                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Registro (POST /api/users/register)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE                                                          â”‚
â”‚ POST /api/users/register                                         â”‚
â”‚ Body: { name, email, password }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROUTE: router.post("/register", userController.register)        â”‚
â”‚ â†’ No requiere middleware de autenticaciÃ³n                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER: register(req, res)                                   â”‚
â”‚                                                                  â”‚
â”‚ 1. Extraer: { name, email, password } = req.body               â”‚
â”‚ 2. Validar que los 3 campos existan                             â”‚
â”‚    â”œâ”€ Si faltan â†’ resp 400 "Faltan datos"                       â”‚
â”‚    â””â”€ Si existen â†’ continuar                                    â”‚
â”‚ 3. Llamar: userService.registerUser({name, email, password})   â”‚
â”‚ 4. Ejecutar try/catch para manejar errores                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE: registerUser({name, email, password})                   â”‚
â”‚                                                                  â”‚
â”‚ 1. Buscar si email ya existe:                                   â”‚
â”‚    existing = await userRepository.findByEmail(email)           â”‚
â”‚                                                                  â”‚
â”‚ 2. Si existe:                                                    â”‚
â”‚    â”œâ”€ Crear Error("El email ya esta registrado")               â”‚
â”‚    â”œâ”€ error.statusCode = 409                                    â”‚
â”‚    â””â”€ throw error â†’ vuelve al controller                        â”‚
â”‚                                                                  â”‚
â”‚ 3. Si NO existe:                                                 â”‚
â”‚    â”œâ”€ Encriptar contraseÃ±a:                                     â”‚
â”‚    â”‚  passwordHash = await bcrypt.hash(password, 10)           â”‚
â”‚    â”‚                                                             â”‚
â”‚    â”œâ”€ Crear usuario en BD:                                      â”‚
â”‚    â”‚  user = await userRepository.createUser(...)              â”‚
â”‚    â”‚                                                             â”‚
â”‚    â””â”€ Retornar: new User(user)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REPOSITORY: createUser({name, email, passwordHash})              â”‚
â”‚                                                                  â”‚
â”‚ 1. Ejecutar INSERT SQL:                                          â”‚
â”‚    INSERT INTO users (name, email, password_hash)              â”‚
â”‚    VALUES ($1, $2, $3)                                          â”‚
â”‚    RETURNING id, name, email, password_hash, created_at         â”‚
â”‚                                                                  â”‚
â”‚ 2. PostgreSQL:                                                   â”‚
â”‚    â”œâ”€ Genera automÃ¡ticamente: id, created_at                   â”‚
â”‚    â”œâ”€ Inserta en tabla users                                    â”‚
â”‚    â””â”€ Retorna datos insertados                                  â”‚
â”‚                                                                  â”‚
â”‚ 3. Transformar datos:                                            â”‚
â”‚    mapRow(row) â†’ { id, name, email, passwordHash, createdAt }  â”‚
â”‚                                                                  â”‚
â”‚ 4. Retornar al servicio: usuario creado                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE retorna al CONTROLLER                                    â”‚
â”‚ new User({ id, name, email, passwordHash, createdAt })         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER retorna respuesta HTTP                                â”‚
â”‚                                                                  â”‚
â”‚ Status: 201 (Created)                                            â”‚
â”‚ Body: {                                                          â”‚
â”‚   id: 1,                                                         â”‚
â”‚   name: "Juan PÃ©rez",                                            â”‚
â”‚   email: "juan@example.com",                                     â”‚
â”‚   createdAt: "2026-02-17T10:30:00.000Z"                         â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE recibe respuesta                                         â”‚
â”‚ âœ… Usuario registrado exitosamente                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Login (POST /api/users/login)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE                                                          â”‚
â”‚ POST /api/users/login                                            â”‚
â”‚ Body: { email, password }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER: login(req, res)                                      â”‚
â”‚ 1. Validar datos                                                 â”‚
â”‚ 2. Llamar: userService.loginUser({email, password})             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE: loginUser({email, password})                            â”‚
â”‚                                                                  â”‚
â”‚ 1. Buscar usuario por email:                                     â”‚
â”‚    user = await userRepository.findByEmail(email)               â”‚
â”‚    â”œâ”€ Si NO existe â†’ throw Error(...) 401                       â”‚
â”‚    â””â”€ Si existe â†’ continuar                                     â”‚
â”‚                                                                  â”‚
â”‚ 2. Comparar contraseÃ±a:                                          â”‚
â”‚    match = await bcrypt.compare(password, user.passwordHash)    â”‚
â”‚    â”œâ”€ Si NO coincide â†’ throw Error(...) 401                     â”‚
â”‚    â””â”€ Si coincide â†’ continuar                                   â”‚
â”‚                                                                  â”‚
â”‚ 3. Generar JWT:                                                  â”‚
â”‚    token = jwt.sign(                                             â”‚
â”‚      { sub: user.id, email: user.email },                       â”‚
â”‚      process.env.JWT_SECRET,                                    â”‚
â”‚      { expiresIn: JWT_EXPIRES_IN }  // "1h"                     â”‚
â”‚    )                                                             â”‚
â”‚                                                                  â”‚
â”‚ 4. Retornar: { token, user: new User(user) }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER retorna respuesta HTTP                                â”‚
â”‚                                                                  â”‚
â”‚ Status: 200 (OK)                                                 â”‚
â”‚ Body: {                                                          â”‚
â”‚   token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",            â”‚
â”‚   user: {                                                        â”‚
â”‚     id: 1,                                                       â”‚
â”‚     name: "Juan PÃ©rez",                                          â”‚
â”‚     email: "juan@example.com"                                    â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE guarda el token                                          â”‚
â”‚ localStorage.setItem('token', response.token)                    â”‚
â”‚ âœ… Login exitoso                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Acceso Protegido (GET /api/users/me)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE                                                          â”‚
â”‚ GET /api/users/me                                                â”‚
â”‚ Header: Authorization: Bearer eyJhbGci...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROUTE: router.get("/me", authMiddleware, userController.me)    â”‚
â”‚ Primero ejecuta authMiddleware                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MIDDLEWARE: authMiddleware(req, res, next)                       â”‚
â”‚                                                                  â”‚
â”‚ 1. Obtener header Authorization:                                 â”‚
â”‚    authHeader = req.headers.authorization || "" 
â”‚    â†’ "Bearer eyJhbGci..."                                        â”‚
â”‚                                                                  â”‚
â”‚ 2. Separar esquema y token:                                      â”‚
â”‚    [scheme, token] = authHeader.split(" ")                       â”‚
â”‚    â†’ scheme = "Bearer"                                           â”‚
â”‚    â†’ token = "eyJhbGci..."                                       â”‚
â”‚                                                                  â”‚
â”‚ 3. Validar estructura:                                           â”‚
â”‚    if (scheme !== "Bearer" || !token) {                         â”‚
â”‚      return res.status(401).json("No autorizado")               â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚ 4. Verificar token JWT:                                          â”‚
â”‚    payload = jwt.verify(token, process.env.JWT_SECRET)          â”‚
â”‚    â”œâ”€ Si VÃLIDO:                                                 â”‚
â”‚    â”‚  req.user = { id: payload.sub, email: payload.email }     â”‚
â”‚    â”‚  return next()  â† ContinÃºa al controlador                  â”‚
â”‚    â”‚                                                             â”‚
â”‚    â””â”€ Si INVÃLIDO/EXPIRADO:                                      â”‚
â”‚       return res.status(401).json("Token invalido")             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ (si token es vÃ¡lido)
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER: me(req, res)                                         â”‚
â”‚                                                                  â”‚
â”‚ 1. Obtener ID del usuario:                                       â”‚
â”‚    userId = req.user.id  â† Agregado por middleware              â”‚
â”‚                                                                  â”‚
â”‚ 2. Llamar servicio:                                              â”‚
â”‚    user = await userService.getProfile(userId)                  â”‚
â”‚                                                                  â”‚
â”‚ 3. Retornar datos del usuario                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE: getProfile(userId)                                      â”‚
â”‚                                                                  â”‚
â”‚ 1. Buscar usuario por ID:                                        â”‚
â”‚    user = await userRepository.findById(userId)                 â”‚
â”‚    â”œâ”€ Si NO existe â†’ throw Error(...) 404                       â”‚
â”‚    â””â”€ Si existe â†’ continuar                                     â”‚
â”‚                                                                  â”‚
â”‚ 2. Retornar: new User(user)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER retorna respuesta HTTP                                â”‚
â”‚                                                                  â”‚
â”‚ Status: 200 (OK)                                                 â”‚
â”‚ Body: {                                                          â”‚
â”‚   id: 1,                                                         â”‚
â”‚   name: "Juan PÃ©rez",                                            â”‚
â”‚   email: "juan@example.com",                                     â”‚
â”‚   createdAt: "2026-02-17T10:30:00.000Z"                         â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE recibe datos del perfil                                  â”‚
â”‚ âœ… AutenticaciÃ³n exitosa                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


NOTA: Si el token es invÃ¡lido o falta:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MIDDLEWARE rechaza la solicitud                                  â”‚
â”‚                                                                  â”‚
â”‚ Status: 401                                                      â”‚
â”‚ Body: { message: "No autorizado" }  o  "Token invalido"        â”‚
â”‚                                                                  â”‚
â”‚ El controlador NUNCA se ejecuta âŒ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Errores - Ejemplo: Email Duplicado

```
CLIENTE: POST /api/users/register
Body: { name: "Juan", email: "juan@email.com", password: "123" }

        â†“
ROUTE â†’ CONTROLLER (valida datos âœ“)
        â†“
SERVICE:
  1. Buscar email en BD
     â†’ Email SÃ existe
  2. Crear Error
     error = new Error("El email ya esta registrado")
     error.statusCode = 409
  3. throw error
     â†“
CONTROLLER catch:
  const status = error.statusCode || 500  â†’ 409
  return res.status(409).json({ message: "El email ya esta registrado" })
     â†“
CLIENTE recibe:
Status: 409 Conflict
Body: { message: "El email ya esta registrado" }
```

---

## Estado de una Solicitud por Fases

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FASES DE UNA SOLICITUD                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ 1. ROUTE MATCHING                                                â”‚
â”‚    req.method = "POST" âœ“                                        â”‚
â”‚    req.path = "/api/users/login" âœ“                              â”‚
â”‚    â†’ router.post("/login", ...) coinc ide                       â”‚
â”‚                                                                  â”‚
â”‚ 2. MIDDLEWARE                                                    â”‚
â”‚    authMiddleware (solo si configurado en ruta)                 â”‚
â”‚    â”œâ”€ Validar header Authorization                             â”‚
â”‚    â”œâ”€ Verificar JWT                                             â”‚
â”‚    â””â”€ Si falla: DETENER, responder 401                         â”‚
â”‚                                                                  â”‚
â”‚ 3. CONTROLLER                                                    â”‚
â”‚    â”œâ”€ Extraer datos del request                                 â”‚
â”‚    â”œâ”€ Validar datos                                             â”‚
â”‚    â”œâ”€ Si falla: responder 400/409/etc                          â”‚
â”‚    â”œâ”€ Llamar servicio                                           â”‚
â”‚    â””â”€ Manejar excepciones en try/catch                          â”‚
â”‚                                                                  â”‚
â”‚ 4. SERVICE                                                       â”‚
â”‚    â”œâ”€ Ejecutar lÃ³gica de negocio                                â”‚
â”‚    â”œâ”€ Validar reglas                                            â”‚
â”‚    â”œâ”€ Llamar repositorio                                        â”‚
â”‚    â””â”€ Thrower de excepciones si hay problemas                   â”‚
â”‚                                                                  â”‚
â”‚ 5. REPOSITORY                                                    â”‚
â”‚    â”œâ”€ Construir SQL                                             â”‚
â”‚    â”œâ”€ Ejecutar query                                            â”‚
â”‚    â”œâ”€ Transformar resultados                                    â”‚
â”‚    â””â”€ Retornar datos                                            â”‚
â”‚                                                                  â”‚
â”‚ 6. DATABASE                                                      â”‚
â”‚    â”œâ”€ Recibir SQL                                               â”‚
â”‚    â”œâ”€ Ejecutar                                                  â”‚
â”‚    â””â”€ Retornar resultados                                       â”‚
â”‚                                                                  â”‚
â”‚ 7. RESPONSE                                                      â”‚
â”‚    â”œâ”€ Enviar status HTTP                                        â”‚
â”‚    â”œâ”€ Enviar headers                                            â”‚
â”‚    â””â”€ Enviar body (JSON)                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Diagrama actualizado:** 17 de febrero de 2026
